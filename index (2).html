<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>富士山旅行助手 - 多人協作版</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.fb = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore, doc, onSnapshot, setDoc, getDoc, collection };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F8FAFC; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .header-curve { border-bottom-left-radius: 40px; border-bottom-right-radius: 40px; background-size: cover; background-position: center; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        .editable-input { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 4px; color: white; padding: 2px 4px; }
        .editable-input-dark { background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 8px; padding: 4px 8px; font-weight: bold; }
        
        .sync-indicator { position: fixed; top: 12px; left: 50%; transform: translateX(-50%); z-index: 1000; font-size: 10px; padding: 4px 12px; border-radius: 99px; font-weight: bold; pointer-events: none; }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen relative shadow-2xl bg-white">
    <div id="app" class="bg-[#F8FAFC] min-h-screen pb-24">
        
        <!-- 連線狀態指示 -->
        <div v-if="isSyncing" class="sync-indicator bg-yellow-400 text-white shadow-lg animate-pulse">雲端同步中...</div>
        <div v-else class="sync-indicator bg-green-500 text-white shadow-lg">雲端連線正常</div>

        <!-- Header -->
        <header :style="{ backgroundImage: `linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.1)), url(${tripInfo.coverImage})` }" 
                class="header-curve h-64 relative flex flex-col justify-end px-6 pb-16 transition-all">
            
            <button @click="changeCover" class="absolute top-4 right-4 bg-white/20 backdrop-blur-md p-2 rounded-full text-white">
                <i data-lucide="camera" class="w-4 h-4"></i>
            </button>

            <div class="flex justify-between items-start mb-4">
                <div class="flex-1 mr-4">
                    <input v-if="isEditingTitle" v-model="tripInfo.title" @blur="isEditingTitle=false; saveToCloud()" @keyup.enter="isEditingTitle=false; saveToCloud()" class="editable-input text-2xl font-bold w-full outline-none" autofocus>
                    <h1 v-else @click="isEditingTitle=true" class="text-white text-3xl font-bold tracking-tighter drop-shadow-lg cursor-pointer">
                        {{ tripInfo.title }}
                    </h1>
                    
                    <div class="mt-1 flex items-center">
                        <i data-lucide="calendar" class="w-3 h-3 mr-1 text-white/80"></i>
                        <input v-if="isEditingDate" v-model="tripInfo.dateRange" @blur="isEditingDate=false; saveToCloud()" @keyup.enter="isEditingDate=false; saveToCloud()" class="editable-input text-[10px] w-full outline-none" autofocus>
                        <p v-else @click="isEditingDate=true" class="text-white/80 text-xs cursor-pointer">
                            {{ tripInfo.dateRange }}
                        </p>
                    </div>
                </div>
                <div class="bg-white/20 backdrop-blur-md p-2 rounded-2xl text-white text-center border border-white/30">
                    <i data-lucide="sun-cloud" class="w-5 h-5 mx-auto mb-1"></i>
                    <p class="text-xs">12°C</p>
                </div>
            </div>

            <div class="absolute -bottom-8 left-0 w-full px-6 z-10">
                <div class="bg-white p-2 rounded-3xl flex justify-around shadow-xl border border-gray-100">
                    <button v-for="tab in tabs" :key="tab.id" @click="activeTab = tab.id" 
                            :class="activeTab === tab.id ? 'bg-[#1C3867] text-white' : 'text-gray-400'"
                            class="flex-1 flex flex-col items-center py-3 rounded-2xl transition-all duration-300">
                        <i :data-lucide="tab.icon" class="w-5 h-5"></i>
                        <span class="text-[10px] mt-1 font-bold">{{ tab.name }}</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="px-5 pt-14 min-h-[500px]">
            <!-- 行程分頁 -->
            <div v-if="activeTab === 'schedule'" class="space-y-6">
                <div class="flex overflow-x-auto no-scrollbar space-x-3 py-2">
                    <div v-for="(day, index) in days" :key="index" 
                         @click="selectedDateIndex = index"
                         :class="selectedDateIndex === index ? 'bg-[#1C3867] text-white scale-105 shadow-lg' : 'bg-white text-gray-400'"
                         class="flex-shrink-0 w-16 h-20 rounded-2xl flex flex-col items-center justify-center cursor-pointer transition-all">
                        <span class="text-[10px] font-bold opacity-70">{{ day.week }}</span>
                        <span class="text-xl font-bold">{{ day.date }}</span>
                    </div>
                </div>

                <div class="space-y-4">
                    <div v-if="!schedules[selectedDateIndex] || schedules[selectedDateIndex].length === 0" class="text-center py-12 text-gray-300">
                        <p class="text-sm">今日尚無行程安排</p>
                    </div>
                    <div v-for="(element, index) in (schedules[selectedDateIndex] || [])" :key="element.id" 
                         class="bg-white p-4 rounded-[2rem] shadow-sm border border-gray-50 mb-4 transition-all">
                        <div class="flex items-start space-x-4">
                            <div class="flex flex-col space-y-1">
                                <button v-if="index > 0" @click="moveSchedule(index, -1)" class="p-1 bg-gray-50 text-gray-400 rounded-lg"><i data-lucide="chevron-up" class="w-3 h-3"></i></button>
                                <div :class="getTypeColor(element.type)" class="w-10 h-10 rounded-xl flex items-center justify-center text-white shadow-inner">
                                    <i :data-lucide="getTypeIcon(element.type)" class="w-5 h-5"></i>
                                </div>
                                <button v-if="index < schedules[selectedDateIndex].length - 1" @click="moveSchedule(index, 1)" class="p-1 bg-gray-50 text-gray-400 rounded-lg"><i data-lucide="chevron-down" class="w-3 h-3"></i></button>
                            </div>
                            <div class="flex-1 min-w-0" @click="editScheduleItem(element)">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-gray-800 truncate">{{ element.name }}</h3>
                                    <span class="text-[9px] px-2 py-0.5 rounded-full bg-gray-100 text-gray-500 font-bold">{{ element.time }}</span>
                                </div>
                                <p v-if="element.address" class="text-[10px] text-blue-500 mt-1 flex items-center"><i data-lucide="map-pin" class="w-3 h-3 mr-1"></i> {{ element.address }}</p>
                                <p class="text-xs text-gray-400 mt-1 italic line-clamp-1">{{ element.note || '點擊編輯備註...' }}</p>
                            </div>
                            <div class="flex flex-col space-y-2">
                                <button @click.stop="navigate(element.address || element.name)" class="bg-blue-50 text-blue-600 p-2 rounded-xl"><i data-lucide="navigation" class="w-4 h-4"></i></button>
                                <button @click.stop="deleteItem(index)" class="text-red-300 p-2 hover:text-red-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    </div>
                    <button @click="openAddSchedule" class="w-full py-4 border-2 border-dashed border-gray-200 rounded-[2rem] text-gray-400 text-sm font-bold flex items-center justify-center">
                        <i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i> 新增今日行程
                    </button>
                </div>
            </div>

            <!-- 資訊分頁 (已更新) -->
            <div v-if="activeTab === 'info'" class="space-y-6 pb-20">
                <!-- 匯率工具 -->
                <div class="bg-[#1C3867] p-6 rounded-[2.5rem] text-white shadow-xl relative overflow-hidden">
                    <h3 class="font-bold mb-4 flex items-center text-sm"><i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i> 快速換算 (1 JPY = {{ exchangeRate }} TWD)</h3>
                    <div class="flex items-center space-x-4">
                        <input v-model="jpyInput" type="number" class="w-full bg-white/10 border-none rounded-2xl p-4 text-xl font-bold text-white outline-none">
                        <i data-lucide="repeat" class="w-6 h-6 opacity-50"></i>
                        <div class="w-full bg-white text-[#1C3867] rounded-2xl p-4 text-xl font-bold">
                            {{ Math.round(jpyInput * exchangeRate) }} <span class="text-xs ml-1">TWD</span>
                        </div>
                    </div>
                </div>

                <!-- 航班資訊 -->
                <div class="px-2">
                    <h3 class="font-bold text-gray-800 text-lg mb-4 flex items-center"><i data-lucide="plane" class="w-5 h-5 mr-2 text-blue-600"></i>航班資訊</h3>
                    <div class="space-y-4">
                        <!-- 去程 -->
                        <div class="bg-white p-5 rounded-[2rem] shadow-sm border-l-4 border-blue-500">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-[10px] bg-blue-50 text-blue-600 px-3 py-1 rounded-full font-black">去程 泰國航空</span>
                                <span class="text-xs font-bold text-gray-400">03.21 (Sat)</span>
                            </div>
                            <div class="flex items-center justify-between mt-3">
                                <div class="text-center flex-1">
                                    <p class="text-xl font-black text-gray-800">08:05</p>
                                    <p class="text-[10px] text-gray-400">高雄 KHH</p>
                                </div>
                                <div class="flex-1 px-4 flex flex-col items-center">
                                    <p class="text-[10px] font-bold text-blue-500">TG611</p>
                                    <div class="w-full h-[1px] bg-gray-100 relative my-2">
                                        <i data-lucide="plane" class="w-3 h-3 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-gray-300"></i>
                                    </div>
                                </div>
                                <div class="text-center flex-1">
                                    <p class="text-xl font-black text-gray-800">12:30</p>
                                    <p class="text-[10px] text-gray-400">成田 NRT</p>
                                </div>
                            </div>
                        </div>
                        <!-- 回程 -->
                        <div class="bg-white p-5 rounded-[2rem] shadow-sm border-l-4 border-orange-500">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-[10px] bg-orange-50 text-orange-600 px-3 py-1 rounded-full font-black">回程 中華航空</span>
                                <span class="text-xs font-bold text-gray-400">03.28 (Sat)</span>
                            </div>
                            <div class="flex items-center justify-between mt-3">
                                <div class="text-center flex-1">
                                    <p class="text-xl font-black text-gray-800">13:20</p>
                                    <p class="text-[10px] text-gray-400">成田 NRT</p>
                                </div>
                                <div class="flex-1 px-4 flex flex-col items-center">
                                    <p class="text-[10px] font-bold text-orange-500">CI103</p>
                                    <div class="w-full h-[1px] bg-gray-100 relative my-2">
                                        <i data-lucide="plane" class="w-3 h-3 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-gray-300 rotate-180"></i>
                                    </div>
                                </div>
                                <div class="text-center flex-1">
                                    <p class="text-xl font-black text-gray-800">16:50</p>
                                    <p class="text-[10px] text-gray-400">高雄 KHH</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 飯店資訊 -->
                <div class="px-2">
                    <h3 class="font-bold text-gray-800 text-lg mb-4 flex items-center"><i data-lucide="hotel" class="w-5 h-5 mr-2 text-indigo-600"></i>飯店資訊</h3>
                    <div class="space-y-4">
                        <div v-for="(hotel, idx) in hotelDetails" :key="idx" class="bg-white p-5 rounded-[2rem] shadow-sm border border-gray-100">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-bold text-gray-800 text-sm flex-1 mr-2">{{ hotel.name }}</h4>
                                <span class="text-[9px] bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded-full font-bold whitespace-nowrap">{{ hotel.stay }}</span>
                            </div>
                            <ul class="space-y-2">
                                <li class="text-[11px] text-gray-500 flex items-start">
                                    <i data-lucide="clock" class="w-3 h-3 mr-2 mt-0.5 text-gray-400"></i>
                                    <span>入住：{{ hotel.checkIn }} / 退房：{{ hotel.checkOut }}</span>
                                </li>
                                <li @click="navigate(hotel.address)" class="text-[11px] text-blue-500 flex items-start cursor-pointer">
                                    <i data-lucide="map-pin" class="w-3 h-3 mr-2 mt-0.5"></i>
                                    <span>{{ hotel.address }}</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 租車資訊 -->
                <div class="px-2">
                    <h3 class="font-bold text-gray-800 text-lg mb-4 flex items-center"><i data-lucide="car" class="w-5 h-5 mr-2 text-emerald-600"></i>租車資訊</h3>
                    <div class="bg-white p-5 rounded-[2rem] shadow-sm border border-gray-100 text-center py-8 text-gray-300">
                        <p class="text-xs">尚無租車預約資訊</p>
                    </div>
                </div>
            </div>

            <!-- 帳目分頁 -->
            <div v-if="activeTab === 'expense'" class="space-y-6 pb-20">
                <div class="bg-[#1C3867] p-8 rounded-[3rem] text-white shadow-2xl">
                    <p class="text-[10px] opacity-60 font-black tracking-widest uppercase mb-1">TOTAL COST</p>
                    <h2 class="text-4xl font-black mb-1">NT$ {{ Math.round(fixedTotalTWD + variableTotalTWD).toLocaleString() }}</h2>
                    <div class="flex justify-between items-center opacity-70 text-[10px] mt-2 border-t border-white/10 pt-2">
                        <span>每人平均 NT$ {{ Math.round((fixedTotalTWD + variableTotalTWD) / 2).toLocaleString() }}</span>
                        <span>匯率: {{ exchangeRate }}</span>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-gray-50">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-black text-gray-800 flex items-center text-sm"><i data-lucide="shield-check" class="w-4 h-4 mr-2 text-blue-600"></i> 固定支出 (TWD)</h3>
                        <button @click="isEditingFixed = !isEditingFixed; if(!isEditingFixed) saveToCloud()" class="text-[10px] font-bold text-blue-600">{{ isEditingFixed ? '完成' : '編輯項目' }}</button>
                    </div>
                    <div class="space-y-3">
                        <div v-for="(item, idx) in fixedExpenses" :key="idx" class="flex flex-col p-4 bg-gray-50 rounded-2xl">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <i :data-lucide="item.icon || 'credit-card'" class="w-4 h-4 text-[#1C3867]"></i>
                                    <input v-if="isEditingFixed" v-model="item.name" class="editable-input-dark text-xs outline-none w-24">
                                    <span v-else class="text-sm font-bold">{{ item.name }}</span>
                                </div>
                                <div class="flex items-center">
                                    <span v-if="!isEditingFixed" class="font-black">NT$ {{ (item.amount || 0).toLocaleString() }}</span>
                                    <input v-else v-model.number="item.amount" type="number" class="editable-input-dark text-xs outline-none w-20 text-right">
                                    <button v-if="isEditingFixed" @click="fixedExpenses.splice(idx, 1)" class="ml-2 text-red-400"><i data-lucide="minus-circle" class="w-3 h-3"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-gray-50">
                    <h3 class="font-black text-gray-800 text-sm mb-4">變動支出明細</h3>
                    <div class="space-y-3">
                        <div v-for="(exp, idx) in expenses" :key="idx" class="flex justify-between items-center p-3 hover:bg-gray-50 rounded-2xl transition-colors">
                            <div class="flex items-center space-x-3 flex-1" @click="editExpenseItem(exp, idx)">
                                <div :class="exp.payer === 'wan' ? 'bg-blue-100 text-blue-600' : 'bg-pink-100 text-pink-600'" class="w-8 h-8 rounded-full flex items-center justify-center text-[10px] font-bold">{{ exp.payer === 'wan' ? '萬' : '黃' }}</div>
                                <div>
                                    <p class="text-sm font-bold text-gray-800">{{ exp.name }}</p>
                                    <p class="text-[10px] text-gray-400">{{ exp.date }} ({{ exp.currency }})</p>
                                </div>
                            </div>
                            <div class="text-right flex items-center space-x-3">
                                <div>
                                    <p class="text-sm font-black" :class="exp.currency === 'JPY' ? 'text-gray-800' : 'text-blue-600'">{{ exp.currency === 'JPY' ? '¥' : 'NT$' }} {{ exp.amount.toLocaleString() }}</p>
                                    <p v-if="exp.currency === 'JPY'" class="text-[9px] text-gray-400">≈ NT$ {{ Math.round(exp.amount * exchangeRate) }}</p>
                                </div>
                                <button @click.stop="deleteExpense(idx)" class="text-red-200 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                <button @click="openExpenseModal" class="w-full py-4 bg-[#1C3867] text-white rounded-[2rem] font-bold shadow-xl">新增變動支出</button>
            </div>

            <!-- 備忘分頁 (原購物分頁) -->
            <div v-if="activeTab === 'shopping'" class="space-y-6 pb-20">
                <div class="bg-white p-5 rounded-[2.5rem] shadow-sm border border-gray-100">
                    <div class="flex justify-between items-end mb-4 px-1">
                        <div>
                            <p class="text-[10px] text-gray-400 font-bold uppercase">備忘錄進度</p>
                            <h3 class="text-2xl font-black text-gray-800">{{ shoppingProgress }}%</h3>
                        </div>
                        <button @click="openShoppingModal" class="bg-[#1C3867] text-white p-3 rounded-2xl shadow-lg"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                    <div class="w-full h-2 bg-gray-100 rounded-full overflow-hidden">
                        <div class="h-full bg-[#1C3867] transition-all" :style="{ width: shoppingProgress + '%' }"></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-4">
                    <div v-for="(item, index) in shoppingList" :key="index" :class="item.done ? 'opacity-60 grayscale' : ''" class="bg-white rounded-3xl p-5 shadow-sm border border-gray-100 flex items-center">
                        <div @click="toggleShoppingDone(item)" class="w-8 h-8 rounded-xl flex items-center justify-center cursor-pointer mr-4" :class="item.done ? 'bg-green-500' : 'bg-gray-100'">
                            <i v-if="item.done" data-lucide="check" class="w-4 h-4 text-white"></i>
                            <div v-else class="w-2 h-2 rounded-full bg-gray-300"></div>
                        </div>
                        <div class="flex-1 min-w-0" @click="editShoppingItem(item, index)">
                            <p class="font-bold text-gray-800 truncate">{{ item.name }}</p>
                            <p class="text-[10px] text-gray-400">點擊編輯內容</p>
                        </div>
                        <button @click.stop="deleteShopping(index)" class="text-red-200 hover:text-red-500 ml-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>
            </div>
        </main>

        <!-- 行程 Modal -->
        <div v-if="showScheduleModal" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[100] flex items-end">
            <div class="bg-white w-full rounded-t-[3rem] p-8 animate-slide-up max-h-[90vh] overflow-y-auto shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black text-gray-800">{{ isEditingItem ? '編輯行程' : '新增行程' }}</h2>
                    <button @click="closeModal('schedule')" class="p-2 bg-gray-100 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-4 gap-2">
                        <button v-for="t in ['sight', 'food', 'hotel', 'shop']" :key="t" @click="modalItem.type = t" :class="modalItem.type === t ? getTypeColor(t) + ' text-white scale-105' : 'bg-gray-100 text-gray-400'" class="py-3 rounded-2xl transition-all flex flex-col items-center">
                            <i :data-lucide="getTypeIcon(t)" class="w-4 h-4 mb-1"></i>
                            <span class="text-[8px] font-bold uppercase">{{ t }}</span>
                        </button>
                    </div>
                    <div class="bg-gray-50 rounded-2xl p-4">
                        <label class="text-[10px] font-bold text-gray-400 block mb-1">名稱</label>
                        <input v-model="modalItem.name" placeholder="例如：新倉山淺間公園" class="w-full bg-transparent border-none outline-none font-bold">
                    </div>
                    <div class="bg-gray-50 rounded-2xl p-4">
                        <label class="text-[10px] font-bold text-gray-400 block mb-1">地址 (用於導航)</label>
                        <input v-model="modalItem.address" placeholder="輸入地址或關鍵字" class="w-full bg-transparent border-none outline-none font-bold">
                    </div>
                    <div class="bg-gray-50 rounded-2xl p-4">
                        <label class="text-[10px] font-bold text-gray-400 block mb-1">時間</label>
                        <input v-model="modalItem.time" placeholder="例如 10:00" class="w-full bg-transparent border-none outline-none font-bold">
                    </div>
                    <div class="bg-gray-50 rounded-2xl p-4">
                        <label class="text-[10px] font-bold text-gray-400 block mb-1">備註</label>
                        <textarea v-model="modalItem.note" class="w-full bg-transparent border-none outline-none text-sm h-20"></textarea>
                    </div>
                    <button @click="saveScheduleItem" class="w-full py-4 bg-[#1C3867] text-white rounded-2xl font-bold shadow-xl">儲存行程</button>
                </div>
            </div>
        </div>

        <!-- 支出 Modal -->
        <div v-if="showExpenseModal" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[100] flex items-end">
            <div class="bg-white w-full rounded-t-[3rem] p-8 animate-slide-up shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black text-gray-800">{{ isEditingExpense ? '編輯紀錄' : '新增紀錄' }}</h2>
                    <button @click="closeModal('expense')" class="p-2 bg-gray-100 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div class="space-y-6">
                    <div class="flex p-1 bg-gray-100 rounded-2xl relative">
                        <div class="absolute inset-y-1 transition-all duration-300 bg-white shadow rounded-xl w-[calc(50%-4px)]" :class="newExpense.currency === 'JPY' ? 'left-1' : 'left-[calc(50%+2px)]'"></div>
                        <button @click="newExpense.currency = 'JPY'" class="flex-1 py-3 text-xs font-bold z-10" :class="newExpense.currency === 'JPY' ? 'text-gray-900' : 'text-gray-400'">JPY 日幣</button>
                        <button @click="newExpense.currency = 'TWD'" class="flex-1 py-3 text-xs font-bold z-10" :class="newExpense.currency === 'TWD' ? 'text-gray-900' : 'text-gray-400'">TWD 台幣</button>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button @click="newExpense.payer = 'wan'" :class="newExpense.payer === 'wan' ? 'bg-blue-500 text-white' : 'bg-gray-50 text-gray-400'" class="py-3 rounded-xl font-bold transition-all">萬</button>
                        <button @click="newExpense.payer = 'huang'" :class="newExpense.payer === 'huang' ? 'bg-pink-400 text-white' : 'bg-gray-50 text-gray-400'" class="py-3 rounded-xl font-bold transition-all">黃</button>
                    </div>
                    <div class="bg-gray-50 rounded-2xl p-4">
                        <label class="text-[10px] font-bold text-gray-400 block mb-1">金額 ({{ newExpense.currency }})</label>
                        <input v-model.number="newExpense.amount" type="number" placeholder="0" class="w-full bg-transparent border-none outline-none text-3xl font-black">
                    </div>
                    <div class="bg-gray-50 rounded-2xl p-4">
                        <label class="text-[10px] font-bold text-gray-400 block mb-1">項目名稱</label>
                        <input v-model="newExpense.name" placeholder="消費內容..." class="w-full bg-transparent border-none outline-none font-bold">
                    </div>
                    <button @click="addExpense" class="w-full py-4 bg-[#1C3867] text-white rounded-2xl font-bold shadow-xl">紀錄支出</button>
                </div>
            </div>
        </div>

        <!-- 備忘 Modal -->
        <div v-if="showShoppingModal" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[100] flex items-end">
            <div class="bg-white w-full rounded-t-[3rem] p-8 animate-slide-up shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black text-gray-800">{{ isEditingShopping ? '編輯備忘' : '新增備忘' }}</h2>
                    <button @click="closeModal('shopping')" class="p-2 bg-gray-100 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div class="space-y-4">
                    <div class="bg-gray-50 rounded-2xl p-4">
                        <label class="text-[10px] font-bold text-gray-400 block mb-1">備忘事項</label>
                        <textarea v-model="newShoppingItem.name" placeholder="輸入待辦或記事..." class="w-full bg-transparent border-none outline-none font-bold h-32"></textarea>
                    </div>
                    <button @click="addShopping" class="w-full py-4 bg-[#1C3867] text-white rounded-2xl font-bold shadow-xl">儲存備忘</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;
        const { fb } = window;

        createApp({
            setup() {
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = fb.initializeApp(firebaseConfig);
                const auth = fb.getAuth(app);
                const db = fb.getFirestore(app);
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'fuji-companion-shared';

                const isSyncing = ref(true);
                const activeTab = ref('schedule');
                const selectedDateIndex = ref(0);
                const jpyInput = ref(5000);
                const exchangeRate = ref(0.21);
                
                const isEditingTitle = ref(false);
                const isEditingDate = ref(false);
                const isEditingFixed = ref(false);
                const isEditingFlights = ref(false);
                const showScheduleModal = ref(false);
                const showShoppingModal = ref(false);
                const showExpenseModal = ref(false);
                const isEditingItem = ref(false);
                const isEditingShopping = ref(false);
                const isEditingExpense = ref(false);
                const currentEditId = ref(null);
                const currentEditIndex = ref(null);

                // 飯店固定資料 (照要求條列化)
                const hotelDetails = [
                    {
                        name: 'MYSTAYS 富士山展望温泉酒店',
                        stay: '03.21 - 03.23',
                        checkIn: '15:00',
                        checkOut: '11:00',
                        address: '2654 Arakura, Fuji-Yoshida-shi, Yamanashi, 富士吉田, 富士河口湖, 日本, 403-0011'
                    },
                    {
                        name: 'Sotetsu Fresa Inn Ueno-Okachimachi',
                        stay: '03.23 - 03.28',
                        checkIn: '15:00',
                        checkOut: '11:00',
                        address: '1-20-8 Ueno, Taito, 上野, 東京, 日本, 110-0005'
                    }
                ];

                const tripInfo = ref({ title: '富士山。河口湖', dateRange: '2026 / 03.21 - 03.28', coverImage: 'https://r.jina.ai/i/0589139ef2a048708170b02f83db5634' });
                const flights = ref({ out: { date: '03.21 (Sat)', no: 'TG611', depTime: '08:05', depAirport: 'KHH', arrTime: '12:30', arrAirport: 'NRT' }, ret: { date: '03.28 (Sat)', no: 'CI103', depTime: '13:20', depAirport: 'NRT', arrTime: '16:50', arrAirport: 'KHH' } });
                const schedules = ref([[],[],[],[],[],[],[],[]]);
                const fixedExpenses = ref([{ name: '機票', amount: 26214, icon: 'plane' }, { name: '飯店', amount: 45000, icon: 'building' }]);
                const expenses = ref([]);
                const shoppingList = ref([]); // 此處作為備忘錄

                const modalItem = ref({ type: 'sight', name: '', address: '', time: '', note: '' });
                const newShoppingItem = ref({ name: '', price: null, done: false });
                const newExpense = ref({ name: '', amount: null, payer: 'wan', date: '3/21', currency: 'JPY' });

                const days = [{ week: 'Sat', date: '21' }, { week: 'Sun', date: '22' }, { week: 'Mon', date: '23' }, { week: 'Tue', date: '24' }, { week: 'Wed', date: '25' }, { week: 'Thu', date: '26' }, { week: 'Fri', date: '27' }, { week: 'Sat', date: '28' }];
                // 購物分頁改名備忘並放最後
                const tabs = [
                    { id: 'schedule', name: '行程', icon: 'map' }, 
                    { id: 'info', name: '資訊', icon: 'info' }, 
                    { id: 'expense', name: '帳目', icon: 'banknote' },
                    { id: 'shopping', name: '備忘', icon: 'sticky-note' }
                ];

                const tripDocRef = fb.doc(db, 'artifacts', appId, 'public', 'data', 'trips', 'main-fuji-data');

                const saveToCloud = async () => {
                    if (!auth.currentUser) return;
                    isSyncing.value = true;
                    try {
                        const data = {
                            tripInfo: tripInfo.value,
                            flights: flights.value,
                            fixedExpenses: fixedExpenses.value,
                            expenses: expenses.value,
                            shoppingList: shoppingList.value,
                            schedules_json: JSON.stringify(schedules.value)
                        };
                        await fb.setDoc(tripDocRef, data, { merge: true });
                        setTimeout(() => isSyncing.value = false, 600);
                    } catch (e) { console.error(e); }
                };

                const initAuthAndSync = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await fb.signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await fb.signInAnonymously(auth);
                    }

                    fb.onSnapshot(tripDocRef, (snap) => {
                        if (snap.exists()) {
                            const d = snap.data();
                            tripInfo.value = d.tripInfo || tripInfo.value;
                            flights.value = d.flights || flights.value;
                            fixedExpenses.value = d.fixedExpenses || fixedExpenses.value;
                            expenses.value = d.expenses || [];
                            shoppingList.value = d.shoppingList || [];
                            if (d.schedules_json) schedules.value = JSON.parse(d.schedules_json);
                            isSyncing.value = false;
                            refreshIcons();
                        } else {
                            saveToCloud();
                        }
                    }, (err) => console.error("Firestore Error:", err));
                };

                const refreshIcons = () => nextTick(() => window.lucide && window.lucide.createIcons());
                const shoppingProgress = computed(() => shoppingList.value.length === 0 ? 0 : Math.round((shoppingList.value.filter(i => i.done).length / shoppingList.value.length) * 100));
                const fixedTotalTWD = computed(() => fixedExpenses.value.reduce((sum, item) => sum + (Number(item.amount) || 0), 0));
                const variableTotalTWD = computed(() => expenses.value.reduce((sum, item) => sum + (item.currency === 'JPY' ? (Number(item.amount)||0) * exchangeRate.value : (Number(item.amount)||0)), 0));

                const changeCover = () => { const url = prompt("封面網址:", tripInfo.value.coverImage); if(url) { tripInfo.value.coverImage = url; saveToCloud(); } };
                const getTypeIcon = (t) => ({ sight: 'map-pin', food: 'utensils', hotel: 'bed', shop: 'shopping-bag' }[t] || 'circle');
                const getTypeColor = (t) => ({ sight: 'bg-emerald-500', food: 'bg-orange-500', hotel: 'bg-indigo-500', shop: 'bg-rose-500' }[t] || 'bg-blue-500');
                const navigate = (addr) => addr && window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(addr)}`, '_blank');
                
                const openAddSchedule = () => { isEditingItem.value = false; modalItem.value = { type: 'sight', name: '', address: '', time: '', note: '' }; showScheduleModal.value = true; refreshIcons(); };
                const editScheduleItem = (i) => { isEditingItem.value = true; currentEditId.value = i.id; modalItem.value = { ...i }; showScheduleModal.value = true; refreshIcons(); };
                const saveScheduleItem = () => {
                    const day = schedules.value[selectedDateIndex.value];
                    if (isEditingItem.value) {
                        const idx = day.findIndex(x => x.id === currentEditId.value);
                        if(idx!==-1) day[idx] = { ...modalItem.value };
                    } else {
                        day.push({ ...modalItem.value, id: Date.now() });
                    }
                    showScheduleModal.value = false;
                    saveToCloud();
                };
                const deleteItem = (idx) => { schedules.value[selectedDateIndex.value].splice(idx, 1); saveToCloud(); };
                const moveSchedule = (idx, dir) => {
                    const list = schedules.value[selectedDateIndex.value];
                    const target = idx + dir;
                    if(target >=0 && target < list.length) { [list[idx], list[target]] = [list[target], list[idx]]; saveToCloud(); }
                };

                const openShoppingModal = () => { isEditingShopping.value = false; newShoppingItem.value = { name: '', price: null, done: false }; showShoppingModal.value = true; refreshIcons(); };
                const editShoppingItem = (item, idx) => { isEditingShopping.value = true; currentEditIndex.value = idx; newShoppingItem.value = { ...item }; showShoppingModal.value = true; refreshIcons(); };
                const addShopping = () => {
                    if(isEditingShopping.value) shoppingList.value[currentEditIndex.value] = { ...newShoppingItem.value };
                    else shoppingList.value.push({ ...newShoppingItem.value });
                    showShoppingModal.value = false;
                    saveToCloud();
                };
                const toggleShoppingDone = (i) => { i.done = !i.done; saveToCloud(); };
                const deleteShopping = (idx) => { shoppingList.value.splice(idx, 1); saveToCloud(); };

                const openExpenseModal = () => { isEditingExpense.value = false; newExpense.value = { name: '', amount: null, payer: 'wan', date: `3/${days[selectedDateIndex.value].date}`, currency: 'JPY' }; showExpenseModal.value = true; refreshIcons(); };
                const editExpenseItem = (exp, idx) => { isEditingExpense.value = true; currentEditIndex.value = idx; newExpense.value = { ...exp }; showExpenseModal.value = true; refreshIcons(); };
                const addExpense = () => {
                    if(isEditingExpense.value) expenses.value[currentEditIndex.value] = { ...newExpense.value };
                    else expenses.value.unshift({ ...newExpense.value });
                    showExpenseModal.value = false;
                    saveToCloud();
                };
                const deleteExpense = (idx) => { expenses.value.splice(idx, 1); saveToCloud(); };

                const closeModal = (t) => { if(t==='schedule') showScheduleModal.value=false; if(t==='shopping') showShoppingModal.value=false; if(t==='expense') showExpenseModal.value=false; refreshIcons(); };

                onMounted(() => initAuthAndSync());
                watch([activeTab, selectedDateIndex], () => refreshIcons());

                return {
                    isSyncing, tripInfo, flights, isEditingTitle, isEditingDate, isEditingFixed, isEditingFlights,
                    activeTab, tabs, days, selectedDateIndex, schedules, jpyInput, exchangeRate, hotelDetails,
                    shoppingList, shoppingProgress, fixedExpenses, fixedTotalTWD, variableTotalTWD, expenses,
                    showScheduleModal, showShoppingModal, showExpenseModal, isEditingItem, isEditingShopping, isEditingExpense,
                    modalItem, newShoppingItem, newExpense,
                    getTypeIcon, getTypeColor, navigate, changeCover, saveToCloud,
                    openAddSchedule, editScheduleItem, saveScheduleItem, moveSchedule, deleteItem,
                    openShoppingModal, editShoppingItem, addShopping, toggleShoppingDone, deleteShopping,
                    openExpenseModal, editExpenseItem, addExpense, deleteExpense, closeModal
                };
            }
        }).mount('#app');
    </script>
</body>
</html>