<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>富士山旅行助手</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.fb = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore, doc, onSnapshot, setDoc, getDoc, collection };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F8FAFC; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .header-curve { border-bottom-left-radius: 40px; border-bottom-right-radius: 40px; background-size: cover; background-position: center; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        .editable-input { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 4px; color: white; padding: 2px 4px; }
        .sync-indicator { position: fixed; top: 12px; left: 50%; transform: translateX(-50%); z-index: 1000; font-size: 10px; padding: 4px 12px; border-radius: 99px; font-weight: bold; pointer-events: none; }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen relative shadow-2xl bg-white">
    <div id="app" class="bg-[#F8FAFC] min-h-screen pb-24">
        
        <!-- 同步狀態 -->
        <div v-if="isSyncing" class="sync-indicator bg-yellow-400 text-white shadow-lg animate-pulse">雲端同步中...</div>
        <div v-else class="sync-indicator bg-green-500 text-white shadow-lg">雲端連線中</div>

        <!-- Header -->
        <header :style="{ backgroundImage: `linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.1)), url(${tripInfo.coverImage})` }" 
                class="header-curve h-64 relative flex flex-col justify-end px-6 pb-16 transition-all">
            
            <button @click="changeCover" class="absolute top-4 right-4 bg-white/20 backdrop-blur-md p-2 rounded-full text-white">
                <i data-lucide="camera" class="w-4 h-4"></i>
            </button>

            <div class="flex justify-between items-start mb-4">
                <div class="flex-1 mr-4">
                    <input v-if="isEditingTitle" v-model="tripInfo.title" @blur="isEditingTitle=false; saveToCloud()" @keyup.enter="isEditingTitle=false; saveToCloud()" class="editable-input text-2xl font-bold w-full outline-none" autofocus>
                    <h1 v-else @click="isEditingTitle=true" class="text-white text-3xl font-bold tracking-tighter drop-shadow-lg cursor-pointer">
                        {{ tripInfo.title }}
                    </h1>
                    <div class="mt-1 flex items-center">
                        <i data-lucide="calendar" class="w-3 h-3 mr-1 text-white/80"></i>
                        <input v-if="isEditingDate" v-model="tripInfo.dateRange" @blur="isEditingDate=false; saveToCloud()" @keyup.enter="isEditingDate=false; saveToCloud()" class="editable-input text-[10px] w-full outline-none" autofocus>
                        <p v-else @click="isEditingDate=true" class="text-white/80 text-xs cursor-pointer">
                            {{ tripInfo.dateRange }}
                        </p>
                    </div>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="absolute -bottom-8 left-0 w-full px-6 z-10">
                <div class="bg-white p-2 rounded-3xl flex justify-around shadow-xl border border-gray-100">
                    <button v-for="tab in tabs" :key="tab.id" @click="activeTab = tab.id" 
                            :class="activeTab === tab.id ? 'bg-[#1C3867] text-white' : 'text-gray-400'"
                            class="flex-1 flex flex-col items-center py-3 rounded-2xl transition-all duration-300">
                        <i :data-lucide="tab.icon" class="w-5 h-5"></i>
                        <span class="text-[10px] mt-1 font-bold">{{ tab.name }}</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="px-5 pt-14">
            
            <!-- 1. 行程分頁 -->
            <div v-if="activeTab === 'schedule'" class="space-y-6">
                <div class="flex overflow-x-auto no-scrollbar space-x-3 py-2">
                    <div v-for="(day, index) in days" :key="index" 
                         @click="selectedDateIndex = index"
                         :class="selectedDateIndex === index ? 'bg-[#1C3867] text-white scale-105 shadow-lg' : 'bg-white text-gray-400'"
                         class="flex-shrink-0 w-16 h-20 rounded-2xl flex flex-col items-center justify-center cursor-pointer transition-all">
                        <span class="text-[10px] font-bold opacity-70">{{ day.week }}</span>
                        <span class="text-xl font-bold">{{ day.date }}</span>
                    </div>
                </div>

                <div class="space-y-4">
                    <div v-for="(item, index) in (schedules[selectedDateIndex] || [])" :key="item.id" class="bg-white p-4 rounded-[2rem] shadow-sm border border-gray-50 flex items-start space-x-4">
                        <div :class="getTypeColor(item.type)" class="w-10 h-10 rounded-xl flex items-center justify-center text-white shrink-0">
                            <i :data-lucide="getTypeIcon(item.type)" class="w-5 h-5"></i>
                        </div>
                        <div class="flex-1 min-w-0" @click="editScheduleItem(item)">
                            <div class="flex justify-between">
                                <h3 class="font-bold text-gray-800 truncate">{{ item.name }}</h3>
                                <span class="text-[9px] px-2 py-0.5 rounded-full bg-gray-100 text-gray-500 font-bold">{{ item.time }}</span>
                            </div>
                            <p v-if="item.address" class="text-[10px] text-blue-500 mt-1 truncate">{{ item.address }}</p>
                            <p class="text-xs text-gray-400 mt-1 italic line-clamp-1">{{ item.note || '無備註' }}</p>
                        </div>
                        <button @click="deleteItem(index)" class="text-red-200 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                    <button @click="openAddSchedule" class="w-full py-4 border-2 border-dashed border-gray-200 rounded-[2rem] text-gray-400 text-sm font-bold flex items-center justify-center">
                        <i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i> 新增行程
                    </button>
                </div>
            </div>

            <!-- 2. 資訊分頁 (重點更新區) -->
            <div v-if="activeTab === 'info'" class="space-y-8 pb-20">
                <!-- 匯率 -->
                <div class="bg-[#1C3867] p-6 rounded-[2.5rem] text-white shadow-xl">
                    <h3 class="font-bold mb-3 flex items-center text-xs"><i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i> 匯率換算 (1 JPY = {{ exchangeRate }} TWD)</h3>
                    <div class="flex items-center space-x-4">
                        <input v-model="jpyInput" type="number" class="w-full bg-white/10 border-none rounded-xl p-3 text-lg font-bold outline-none">
                        <i data-lucide="arrow-right-left" class="w-5 h-5 opacity-50"></i>
                        <div class="w-full bg-white text-[#1C3867] rounded-xl p-3 text-lg font-bold">{{ Math.round(jpyInput * exchangeRate) }} <span class="text-[10px] ml-1">TWD</span></div>
                    </div>
                </div>

                <!-- 航班資訊 -->
                <div>
                    <h3 class="font-bold text-gray-800 flex items-center mb-4"><i data-lucide="plane" class="w-5 h-5 mr-2 text-blue-500"></i> 航班資訊</h3>
                    <div class="space-y-3">
                        <div class="bg-white p-5 rounded-[2rem] border-l-4 border-blue-500 shadow-sm">
                            <div class="flex justify-between text-[10px] font-bold text-blue-500 mb-2"><span>泰國航空 (去程)</span><span>2026/03/21</span></div>
                            <div class="flex justify-between items-center">
                                <div class="text-center"><p class="text-lg font-black">08:05</p><p class="text-[10px] text-gray-400">高雄 KHH</p></div>
                                <div class="flex-1 px-4 text-center border-b border-gray-100 pb-1 mx-2"><i data-lucide="plane" class="w-3 h-3 inline text-gray-300"></i></div>
                                <div class="text-center"><p class="text-lg font-black">12:30</p><p class="text-[10px] text-gray-400">成田 NRT</p></div>
                            </div>
                        </div>
                        <div class="bg-white p-5 rounded-[2rem] border-l-4 border-orange-500 shadow-sm">
                            <div class="flex justify-between text-[10px] font-bold text-orange-500 mb-2"><span>中華航空 (回程)</span><span>2026/03/28</span></div>
                            <div class="flex justify-between items-center">
                                <div class="text-center"><p class="text-lg font-black">13:20</p><p class="text-[10px] text-gray-400">成田 NRT</p></div>
                                <div class="flex-1 px-4 text-center border-b border-gray-100 pb-1 mx-2"><i data-lucide="plane" class="w-3 h-3 inline text-gray-300 rotate-180"></i></div>
                                <div class="text-center"><p class="text-lg font-black">16:50</p><p class="text-[10px] text-gray-400">高雄 KHH</p></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 飯店資訊 (條列式) -->
                <div>
                    <h3 class="font-bold text-gray-800 flex items-center mb-4"><i data-lucide="building-2" class="w-5 h-5 mr-2 text-indigo-500"></i> 飯店資訊</h3>
                    <div class="space-y-4">
                        <div v-for="(hotel, idx) in hotelDetails" :key="idx" class="bg-white p-5 rounded-[2rem] shadow-sm border border-gray-100">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-bold text-gray-800 text-sm">{{ hotel.name }}</h4>
                                <span class="text-[9px] bg-indigo-50 text-indigo-600 px-2 py-1 rounded-full font-bold">{{ hotel.stay }}</span>
                            </div>
                            <ul class="text-[11px] space-y-2 text-gray-500 mt-3">
                                <li class="flex items-start"><i data-lucide="clock" class="w-3 h-3 mr-2 mt-0.5"></i> 入住：{{ hotel.checkIn }} / 退房：{{ hotel.checkOut }}</li>
                                <li class="flex items-start"><i data-lucide="map-pin" class="w-3 h-3 mr-2 mt-0.5"></i> 地址：{{ hotel.address }}</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 租車資訊 -->
                <div>
                    <h3 class="font-bold text-gray-800 flex items-center mb-4"><i data-lucide="car" class="w-5 h-5 mr-2 text-emerald-500"></i> 租車資訊</h3>
                    <div class="bg-white p-8 rounded-[2rem] border border-dashed border-gray-200 text-center text-gray-300 text-xs">尚無預約資訊</div>
                </div>
            </div>

            <!-- 3. 帳目分頁 -->
            <div v-if="activeTab === 'expense'" class="space-y-6 pb-20">
                <div class="bg-[#1C3867] p-8 rounded-[3rem] text-white shadow-xl text-center">
                    <p class="text-[10px] opacity-60 font-black tracking-widest uppercase mb-1">TOTAL EXPENSES</p>
                    <h2 class="text-4xl font-black">NT$ {{ Math.round(fixedTotalTWD + variableTotalTWD).toLocaleString() }}</h2>
                </div>
                <!-- 變動支出列表 -->
                <div class="space-y-3">
                    <div v-for="(exp, idx) in expenses" :key="idx" class="bg-white p-4 rounded-3xl shadow-sm flex justify-between items-center">
                        <div class="flex items-center space-x-3">
                            <div :class="exp.payer === 'wan' ? 'bg-blue-100 text-blue-600' : 'bg-pink-100 text-pink-600'" class="w-8 h-8 rounded-full flex items-center justify-center text-[10px] font-bold">{{ exp.payer === 'wan' ? '萬' : '黃' }}</div>
                            <div>
                                <p class="text-sm font-bold text-gray-800">{{ exp.name }}</p>
                                <p class="text-[10px] text-gray-400">{{ exp.date }}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-black text-gray-800">{{ exp.currency === 'JPY' ? '¥' : 'NT$' }} {{ exp.amount.toLocaleString() }}</p>
                            <p v-if="exp.currency === 'JPY'" class="text-[9px] text-gray-400">≈ NT$ {{ Math.round(exp.amount * exchangeRate) }}</p>
                        </div>
                    </div>
                </div>
                <button @click="openExpenseModal" class="w-full py-4 bg-[#1C3867] text-white rounded-2xl font-bold shadow-lg">新增支出紀錄</button>
            </div>

            <!-- 4. 備忘分頁 (由購物修改) -->
            <div v-if="activeTab === 'memo'" class="space-y-6 pb-20">
                <div class="flex justify-between items-center px-2">
                    <h3 class="font-black text-gray-800 text-lg">旅程備忘錄</h3>
                    <button @click="openMemoModal" class="bg-[#1C3867] text-white p-2 rounded-xl shadow-md"><i data-lucide="plus" class="w-5 h-5"></i></button>
                </div>
                <div class="grid grid-cols-1 gap-4">
                    <div v-for="(item, idx) in memoList" :key="idx" class="bg-white p-5 rounded-[2rem] shadow-sm border border-gray-100 flex items-start space-x-4">
                        <button @click="toggleMemoDone(item)" class="mt-1">
                            <i :data-lucide="item.done ? 'check-circle' : 'circle'" :class="item.done ? 'text-green-500' : 'text-gray-300'" class="w-6 h-6"></i>
                        </button>
                        <div class="flex-1" @click="editMemoItem(item, idx)">
                            <p :class="item.done ? 'line-through text-gray-300' : 'text-gray-800'" class="font-bold text-sm leading-relaxed">{{ item.text }}</p>
                            <p class="text-[9px] text-gray-400 mt-2">最後修改: {{ item.time }}</p>
                        </div>
                        <button @click="deleteMemo(idx)" class="text-red-100 hover:text-red-400 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                    <div v-if="memoList.length === 0" class="text-center py-20 text-gray-300 text-xs">還沒有任何備忘事項</div>
                </div>
            </div>
        </main>

        <!-- Modals -->
        <div v-if="showMemoModal" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[100] flex items-end">
            <div class="bg-white w-full rounded-t-[3rem] p-8 animate-slide-up shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black text-gray-800">新增備忘</h2>
                    <button @click="showMemoModal = false" class="p-2 bg-gray-100 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <textarea v-model="tempMemo.text" placeholder="在這裡輸入內容..." class="w-full h-40 bg-gray-50 rounded-2xl p-4 outline-none font-bold text-gray-700 mb-6"></textarea>
                <button @click="saveMemo" class="w-full py-4 bg-[#1C3867] text-white rounded-2xl font-bold shadow-xl">儲存</button>
            </div>
        </div>

        <!-- 快速加載 Expense Modal (省略內容，邏輯與前述一致) -->
        <div v-if="showExpenseModal" class="fixed inset-0 bg-black/60 backdrop-blur-md z-[100] flex items-end">
             <div class="bg-white w-full rounded-t-[3rem] p-8 animate-slide-up">
                 <div class="flex justify-between items-center mb-6"><h2 class="font-black">新增支出</h2><button @click="showExpenseModal=false"><i data-lucide="x"></i></button></div>
                 <input v-model.number="tempExp.amount" type="number" placeholder="金額" class="w-full p-4 bg-gray-50 rounded-xl mb-4 text-2xl font-black">
                 <input v-model="tempExp.name" placeholder="項目" class="w-full p-4 bg-gray-50 rounded-xl mb-6 font-bold">
                 <button @click="saveExp" class="w-full py-4 bg-[#1C3867] text-white rounded-xl font-bold">儲存紀錄</button>
             </div>
        </div>

    </div>

    <script type="module">
        const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;
        const { fb } = window;

        createApp({
            setup() {
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = fb.initializeApp(firebaseConfig);
                const auth = fb.getAuth(app);
                const db = fb.getFirestore(app);
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'fuji-travel-assistant';

                const isSyncing = ref(true);
                const activeTab = ref('schedule');
                const selectedDateIndex = ref(0);
                const exchangeRate = ref(0.21);
                const jpyInput = ref(5000);

                const isEditingTitle = ref(false);
                const isEditingDate = ref(false);
                const showMemoModal = ref(false);
                const showExpenseModal = ref(false);

                const hotelDetails = [
                    { name: 'MYSTAYS 富士山展望温泉酒店', stay: '03.21 - 03.23', checkIn: '15:00後', checkOut: '11:00前', address: '2654 Arakura, Fuji-Yoshida-shi, Yamanashi, 富士吉田, 富士河口湖, 日本, 403-0011' },
                    { name: 'Sotetsu Fresa Inn Ueno-Okachimachi', stay: '03.23 - 03.28', checkIn: '15:00後', checkOut: '11:00前', address: '1-20-8 Ueno, Taito, 上野, 東京, 日本, 110-0005' }
                ];

                const tripInfo = ref({ title: '富士山之旅', dateRange: '2026/03/21 - 03/28', coverImage: 'https://r.jina.ai/i/0589139ef2a048708170b02f83db5634' });
                const schedules = ref([[],[],[],[],[],[],[],[]]);
                const expenses = ref([]);
                const memoList = ref([]);
                const fixedExpenses = ref([{ name: '機票', amount: 26214 }, { name: '預付飯店', amount: 15000 }]);

                const tempMemo = ref({ text: '', done: false });
                const tempExp = ref({ name: '', amount: 0, currency: 'JPY', payer: 'wan', date: '3/21' });

                const days = [{ week: 'Sat', date: '21' }, { week: 'Sun', date: '22' }, { week: 'Mon', date: '23' }, { week: 'Tue', date: '24' }, { week: 'Wed', date: '25' }, { week: 'Thu', date: '26' }, { week: 'Fri', date: '27' }, { week: 'Sat', date: '28' }];
                const tabs = [
                    { id: 'schedule', name: '行程', icon: 'map' }, 
                    { id: 'info', name: '資訊', icon: 'info' }, 
                    { id: 'expense', name: '帳目', icon: 'banknote' },
                    { id: 'memo', name: '備忘', icon: 'sticky-note' }
                ];

                const docRef = fb.doc(db, 'artifacts', appId, 'public', 'data', 'trips', 'main-config');

                const saveToCloud = async () => {
                    if (!auth.currentUser) return;
                    isSyncing.value = true;
                    try {
                        await fb.setDoc(docRef, {
                            tripInfo: tripInfo.value,
                            schedules_json: JSON.stringify(schedules.value),
                            expenses: expenses.value,
                            memoList: memoList.value,
                            fixedExpenses: fixedExpenses.value
                        }, { merge: true });
                        setTimeout(() => isSyncing.value = false, 500);
                    } catch (e) { console.error(e); }
                };

                const init = async () => {
                    if (typeof __initial_auth_token !== 'undefined') await fb.signInWithCustomToken(auth, __initial_auth_token);
                    else await fb.signInAnonymously(auth);

                    fb.onSnapshot(docRef, (snap) => {
                        if (snap.exists()) {
                            const d = snap.data();
                            tripInfo.value = d.tripInfo || tripInfo.value;
                            if(d.schedules_json) schedules.value = JSON.parse(d.schedules_json);
                            expenses.value = d.expenses || [];
                            memoList.value = d.memoList || [];
                            fixedExpenses.value = d.fixedExpenses || fixedExpenses.value;
                            isSyncing.value = false;
                            nextTick(() => window.lucide && window.lucide.createIcons());
                        }
                    });
                };

                const fixedTotalTWD = computed(() => fixedExpenses.value.reduce((s, i) => s + (i.amount || 0), 0));
                const variableTotalTWD = computed(() => expenses.value.reduce((s, i) => s + (i.currency === 'JPY' ? i.amount * exchangeRate.value : i.amount), 0));

                const getTypeIcon = (t) => ({ sight: 'map-pin', food: 'utensils', hotel: 'bed', shop: 'shopping-bag' }[t]);
                const getTypeColor = (t) => ({ sight: 'bg-emerald-500', food: 'bg-orange-500', hotel: 'bg-indigo-500', shop: 'bg-rose-500' }[t]);

                const openMemoModal = () => { tempMemo.value = { text: '', done: false, time: new Date().toLocaleString() }; showMemoModal.value = true; nextTick(() => window.lucide.createIcons()); };
                const saveMemo = () => { if(tempMemo.value.text) memoList.value.unshift({...tempMemo.value}); showMemoModal.value = false; saveToCloud(); };
                const toggleMemoDone = (i) => { i.done = !i.done; saveToCloud(); };
                const deleteMemo = (idx) => { memoList.value.splice(idx, 1); saveToCloud(); };

                const openExpenseModal = () => { tempExp.value = { name: '', amount: 0, currency: 'JPY', payer: 'wan', date: `3/${days[selectedDateIndex.value].date}` }; showExpenseModal.value = true; nextTick(() => window.lucide.createIcons()); };
                const saveExp = () => { if(tempExp.value.amount > 0) expenses.value.unshift({...tempExp.value}); showExpenseModal.value = false; saveToCloud(); };

                const deleteItem = (idx) => { schedules.value[selectedDateIndex.value].splice(idx, 1); saveToCloud(); };
                const changeCover = () => { const u = prompt("輸入網址:"); if(u) { tripInfo.value.coverImage = u; saveToCloud(); } };

                onMounted(() => init());
                watch([activeTab, selectedDateIndex], () => nextTick(() => window.lucide.createIcons()));

                return {
                    isSyncing, tripInfo, activeTab, tabs, days, selectedDateIndex, schedules, exchangeRate, jpyInput, hotelDetails,
                    expenses, memoList, fixedTotalTWD, variableTotalTWD, isEditingTitle, isEditingDate, showMemoModal, showExpenseModal,
                    tempMemo, tempExp, getTypeIcon, getTypeColor, deleteItem, changeCover, saveToCloud, openMemoModal, saveMemo, 
                    toggleMemoDone, deleteMemo, openExpenseModal, saveExp
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
